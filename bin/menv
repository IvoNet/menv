#!/usr/bin/env bash

bold="$(tput bold)"
reset="$(tput sgr0)"
red="$(tput setaf 1)"
green="$(tput setaf 2)"

set -e
[[ -n "$MENV_DEBUG" ]] && set -x

VERSION="1.1"
MENV_PROFILE=".menv_profile"

install_menv_mvn() {
    rm -f /usr/local/bin/mvn 2>/dev/null
    menv_mvn="$(find $(brew --cellar)/menv -depth 1 -type d|sort|tail -1)/libexec/bin/mvn"
    ln -s "${menv_mvn}" /usr/local/bin/mvn
}
install_menv_mvn

# creating the menv home if not exists
if [[ ! -d "${HOME}/.menv" ]]; then
    mkdir -p "${HOME}/.menv" 2>/dev/null
fi

USAGE=$(
cat <<EOF
Usage: menv <command> [<args>]

-a | active                   Show active profile.
-h | help                     Help information.
-v | version                  Show version information.
-p <arg> | profile <arg>      Sets the "settings.xml.<arg>" as the wanted profile for this folder and underlying folders.
-d | delete                   Deletes the set menv profile for this directory (if exists).
-l | list                     Lists all possible profiles you can choose from.
-i | install                  Initialize menv for mvn.

Naming convention:

- ~/.menv/settings.xml.<NAME_OF_PROFILE>
  These files will be seen as possible profiles you can set
  They should be your custom settings.xml files
- ~/.menv/<NAME_OF_PROFILE>.maven_opts
  These files will be seen as custom MAVEN_OPTS for the profiles.
  it can contain 1 line with all the MAVEN_OPTS in it
EOF
)

die() {
    echo >&2 "[${red}${bold}ERROR${reset}] The job ended in error."
    echo -e "[${red}${bold}ERROR${reset}] $*"
    exit 1
}

save_orig_settings_xml() {
    if [[ -f "${HOME}/.m2/settings.xml" ]]; then
        cp "${HOME}/.m2/settings.xml" "${HOME}/.menv/settings.xml.default"
    fi
    orig_settings="$(find $(brew --cellar)/maven -depth 1 -type d|sort|tail -1)/libexec/conf/settings.xml"
    if [[ -f "${orig_settings}" ]]; then
        cp "${orig_settings}" "${HOME}/.menv/settings.xml.original"
    fi
    touch "${HOME}/.menv/.activated"
}


list_settings() {
    ls ${HOME}/.menv/settings.xml.*|sed "s/^.*settings.xml.//g"
}

find_local_version_file() {
  local root="$1"
  while [ -n "$root" ]; do
    if [ -e "${root}/.menv_profile" ]; then
      CURRENT_PROFILE_FILE="${root}/.menv_profile"
      return
     fi
    root="${root%/*}"
  done
}

print_active_profile() {
  find_local_version_file "$MENV_DIR"
  [ "$MENV_DIR" = "$PWD" ] || find_local_version_file "$PWD"

  if [[ -f "${CURRENT_PROFILE_FILE}" ]]; then
      ACTIVE_PROFILE=$(<"${CURRENT_PROFILE_FILE}")
    else
      ACTIVE_PROFILE=default
  fi

  echo "Active profile: [${green}${bold}${ACTIVE_PROFILE}${reset}]"
}

case "$1" in
    active|-a)
        print_active_profile
        exit 0
        ;;
    delete|-d)
        rm -f "${MENV_PROFILE}" 2>/dev/null
        exit 0
        ;;
    help|-h)
        echo "$USAGE"
        exit 0
        ;;
    install|-i)
        install_menv_mvn
        exit 0
        ;;
    list|-l)
        list_settings
        exit 0
        ;;
    profile|-p)
        PROFILE=$2
        ;;
    version|-v)
        echo "$(basename "$0") (c) 2021 by @ivonet"
        echo "Version ${VERSION}"
        exit 0
        ;;
    *)
        die "Unknown OPTION.\n$USAGE"
        ;;
esac

# initial save of the original settings.xml
if [[ ! -f "${HOME}/.menv/.activated" ]]; then
    save_orig_settings_xml
fi

# you must do something
if [[ -z "${PROFILE}" ]]; then
    die "Please provide an OPTION.\n$USAGE"
fi

if [[ ! -z "${PROFILE}" ]]; then
    if [[ -f "${HOME}/.menv/settings.xml.${PROFILE}" ]]; then
        echo "Setting current maven project to ${PROFILE}..."
        echo "${PROFILE}">"${MENV_PROFILE}"
    else
        echo "[${red}${bold}ERROR${reset}] The file \"${HOME}/.menv/settings.xml.${PROFILE}\" does not exist."
        echo "Please use one of the following options:"
        list_settings
        echo "Or create a new settings.xml.PROFILE file in ${HOME}/.menv"
        exit 1
    fi
fi
