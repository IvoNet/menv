#!/usr/bin/env bash

bold="$(tput bold)"
reset="$(tput sgr0)"
red="$(tput setaf 1)"
green="$(tput setaf 2)"

set -e
[[ -n "$MENV_DEBUG" ]] && set -x

VERSION="2.0"
MENV_PROFILE=".menv_profile"

USAGE=$(
cat <<EOF
Usage: menv <command> [<args>]

-a | active                   Show active profile.
idea                          Override IntelliJ mvn user settings file to profile "settings.xml".
-h | help                     Help information.
-v | version                  Show version information.
-p <arg> | profile <arg>      Sets the "settings.xml.<arg>" as the wanted profile for this folder and underlying folders.
-d | delete                   Deletes the set menv profile for this directory (if exists).
-l | list                     Lists all possible profiles you can choose from.
-i | install                  Initialize menv for mvn.

Naming convention:

- ~/.menv/settings.xml.<NAME_OF_PROFILE>
  These files will be seen as possible profiles you can set
  They should be your custom settings.xml files
- ~/.menv/<NAME_OF_PROFILE>.maven_opts
  These files will be seen as custom MAVEN_OPTS for the profiles.
  it can contain 1 line with all the MAVEN_OPTS in it
EOF
)

WORKSPACE_TEMPLATE=$(
cat <<EOF
    <component name="MavenImportPreferences">
        <option name="generalSettings">
            <MavenGeneralSettings>
                <option name="userSettingsFile" value="${HOME}/.menv/settings.xml.TEMPLATE" />
            </MavenGeneralSettings>
        </option>
    </component>
</project>
EOF
)

install_menv_mvn() {
  echo "menv is now ready for use."
  rm -f /usr/local/bin/mvn 2>/dev/null
  menv_mvn="$(find "$(brew --cellar)"/menv -depth 1 -type d|sort|tail -1)/libexec/bin/mvn"
  ln -s "${menv_mvn}" /usr/local/bin/mvn
}

die() {
  echo >&2 "[${red}${bold}ERROR${reset}] The job ended in error."
  echo -e "[${red}${bold}ERROR${reset}] $*"
  exit 1
}

save_orig_settings_xml() {
  if [[ -f "${HOME}/.m2/settings.xml" ]]; then
    cp "${HOME}/.m2/settings.xml" "${HOME}/.menv/m2_settings.xml"
  fi
  orig_settings="$(find "$(brew --cellar)"/maven -depth 1 -type d|sort|tail -1)/libexec/conf/settings.xml"
  if [[ -f "${orig_settings}" ]]; then
    cp "${orig_settings}" "${HOME}/.menv/libexec_settings.xml"
  fi
  touch "${HOME}/.menv/.activated"
}

list_settings() {
  ls ${HOME}/.menv/settings.xml.*|sed "s/^.*settings.xml.//g"
}

find_local_version_file() {
  local root="$1"
  while [ -n "$root" ]; do
    if [ -e "${root}/.menv_profile" ]; then
      CURRENT_PROFILE_FILE="${root}/.menv_profile"
      return
     fi
    root="${root%/*}"
  done
}

print_active_profile() {
  find_local_version_file "$MENV_DIR"
  [ "$MENV_DIR" = "$PWD" ] || find_local_version_file "$PWD"

  if [[ -f "${CURRENT_PROFILE_FILE}" ]]; then
    ACTIVE_PROFILE=$(<"${CURRENT_PROFILE_FILE}")
  else
    ACTIVE_PROFILE="system default"
  fi

  echo -e "Active profile: [${green}${bold}${ACTIVE_PROFILE}${reset}]"

  if [ "${ACTIVE_PROFILE}" != "system default" ] && [[ -f "${HOME}/.menv/${ACTIVE_PROFILE}.maven_opts" ]]; then
    ACTIVE_OPTIONS=$(<"${HOME}/.menv/${ACTIVE_PROFILE}.maven_opts")
    echo -e "Profile specific MAVEN_OPTS: [${green}${bold}$ACTIVE_OPTIONS${reset}]"
  elif [[ -n $MAVEN_OPTS ]]; then
    echo -e "System specific MAVEN_OPTS: [${green}${bold}${MAVEN_OPTS}${reset}]"
  fi

}

set_profile() {
  if [[ -z "${1}" ]]; then
    die "Please provide an OPTION.\n$USAGE"
  fi

  PROFILE=${1}

  if [[ -f "${HOME}/.menv/settings.xml.${PROFILE}" ]]; then
    echo -e "Setting current maven project to [${green}${bold}${PROFILE}${reset}]"
    echo "${PROFILE}">"${MENV_PROFILE}"
    exit 0
  else
    echo "[${red}${bold}ERROR${reset}] Profile [${green}${bold}${PROFILE}${reset}] does not exist."
    echo "Please use one of the following options:"
    list_settings
    echo "Or create a new settings.xml.PROFILE file in ${HOME}/.menv"
    exit 1
  fi
}

set_profile_for_idea_project() {

  # Check if .idea folder exists, create if absent.
  if [[ ! -d "${PWD}/.idea" ]]; then
    echo "Not an idea project."
    exit 0
  fi

  # Check if menv has a profile set for this directory, return if absent.
  find_local_version_file "$MENV_DIR"
  [ "$MENV_DIR" = "$PWD" ] || find_local_version_file "$PWD"
  if [[ -f "${CURRENT_PROFILE_FILE}" ]]; then
    ACTIVE_PROFILE=$(<"${CURRENT_PROFILE_FILE}")
  else
    echo "No menv profile available."
    exit 0
  fi

  workspace_file="${PWD}/.idea/workspace.xml"

  # Check if workspace.xml file exists, create if absent.
  if [[ ! -f "${workspace_file}" ]]; then
    echo "<project>" >> "${workspace_file}"
    echo "</project>" >> "${workspace_file}"
  fi

  # Check if profile is already set for project.
  if [[ $(< "${workspace_file}") == *"settings.xml.${ACTIVE_PROFILE}\""* ]]; then
    echo -e "Profile [${green}${bold}${ACTIVE_PROFILE}${reset}] already set for this idea project."
    exit 0
  fi

  # Check if any profile is set, inline replace settings.xml if present.
  if [[ $(< "${workspace_file}") == *"MavenImportPreferences"* ]]; then
    echo -e "Profile [${green}${bold}${ACTIVE_PROFILE}${reset}] has been set for this idea project."
    sed -i -e "s|menv/settings.xml.[A-Za-z]*\"|menv/settings.xml.${ACTIVE_PROFILE}\"|" "${workspace_file}"
    exit 0
  fi

  # No profile is present, add current profile.
  sed -i '' '/^[[:space:]]*$/d' "${workspace_file}" # Remove empty lines at end of file
  sed -i '' -e '$ d' "${workspace_file}" # remove last line </project>
  echo "${WORKSPACE_TEMPLATE}" >> "${workspace_file}"
  sed -i -e 's|TEMPLATE|'"${ACTIVE_PROFILE}"'|g' "${workspace_file}"
  echo -e "Profile [${green}${bold}${ACTIVE_PROFILE}${reset}] activated for this idea project."
  exit 0
}

unset_profile_for_idea_project() {

    # Check if .idea folder exists, create if absent.
    if [[ ! -d "${PWD}/.idea" ]]; then
      echo "Not an idea project."
      exit 0
    fi

    workspace_file="${PWD}/.idea/workspace.xml"

    if [[ ! -f "${workspace_file}" ]]; then
      echo "No menv profile was set."
      exit 0
    fi

    # Check if menv has a profile set for this directory, return if absent.
    find_local_version_file "$MENV_DIR"
    [ "$MENV_DIR" = "$PWD" ] || find_local_version_file "$PWD"
    if [[ -f "${CURRENT_PROFILE_FILE}" ]]; then
      ACTIVE_PROFILE=$(<"${CURRENT_PROFILE_FILE}")
    else
      echo "No menv profile available."
      exit 0
    fi

    # Check if the active profile was set
    if [[ ! $(< "${workspace_file}") == *"menv/settings.xml.${ACTIVE_PROFILE}\""* ]]; then
      echo "No menv profile was set."
      exit 0
    fi

    echo -e "Profile [${green}${bold}${ACTIVE_PROFILE}${reset}] removed for this idea project."
    sed -i '' '/<component name="MavenImportPreferences">/,/<\/component>/d' .idea/workspace.xml
}

# creating the menv home if not exists
if [[ ! -d "${HOME}/.menv" ]]; then
  mkdir -p "${HOME}/.menv" 2>/dev/null
  install_menv_mvn
fi

# initial save of the original settings.xml
if [[ ! -f "${HOME}/.menv/.activated" ]]; then
  save_orig_settings_xml
fi

case "$1" in
  active|-a)
    print_active_profile
    exit 0
    ;;
  delete|-d)
    rm -f "${MENV_PROFILE}" 2>/dev/null
    exit 0
    ;;
  help|-h)
    echo "$USAGE"
    exit 0
    ;;
  install|-i)
    install_menv_mvn
    exit 0
    ;;
  list|-l)
    list_settings
    exit 0
    ;;
  profile|-p)
    set_profile "$2"
    ;;
  version|-v)
    echo "$(basename "$0") (c) 2021 by Ivo Woltring"
    echo "Version ${VERSION}"
    exit 0
    ;;
  idea)
    set_profile_for_idea_project
    exit 0
    ;;
  rmidea)
    unset_profile_for_idea_project
    exit 0
    ;;
  *)
    die "Unknown OPTION.\n$USAGE"
    ;;
esac
